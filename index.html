<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>Kaleidoscope ‚Äî Psychedelic Pro</title>
<style>
:root{
  --neon:#35ff8a; --neon2:#7cf6ff; --hot:#ff6db4; --gold:#ffe66d;
  --ink:#06090c; --panel1:#0a1117; --panel2:#0b1614; --line:#193b2f;
  --text:#eaffef; --muted:#a8e6c6;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--ink);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}

/* Animated psychedelic base (behind everything) */
.bg{position:fixed;inset:0;z-index:-2;filter:contrast(1.05) saturate(1.15);
  background:
   radial-gradient(120vw 120vh at 15% 10%, #081018 0%, transparent 55%),
   radial-gradient(120vw 120vh at 90% 20%, #0b0f18 0%, transparent 55%),
   conic-gradient(from 0deg at 50% 50%, #0b1016, #0b141b, #0b1016);
  overflow:hidden;}
.bg::before,.bg::after{content:"";position:absolute;inset:-20%;
  background:
    radial-gradient(40% 30% at 20% 40%, rgba(124,246,255,.35), transparent 60%),
    radial-gradient(35% 30% at 80% 60%, rgba(53,255,138,.25), transparent 60%),
    radial-gradient(25% 22% at 50% 70%, rgba(255,109,180,.22), transparent 60%),
    radial-gradient(18% 16% at 70% 30%, rgba(255,230,109,.20), transparent 60%);
  filter:blur(40px);animation:swirl 30s linear infinite;}
.bg::after{animation-duration:42s;mix-blend-mode:screen;transform:scale(1.2)}
@keyframes swirl{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.05)}100%{transform:rotate(360deg) scale(1)}}

/* Force-visible launcher */
#btn-t2{
  position:fixed;left:14px;bottom:14px;z-index:2147483647;
  padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:900;letter-spacing:.3px;color:var(--text);
  background:linear-gradient(180deg,#081710,#07120f);
  border:1px solid color-mix(in oklab, var(--neon) 70%, #0000 30%);
  box-shadow:0 0 24px color-mix(in oklab, var(--neon) 40%, transparent), inset 0 0 14px #0c3b2944}
#btn-t2 .glow{display:inline-block;padding:0 6px;margin-left:6px;border-radius:10px;
  background:radial-gradient(60% 80% at 50% 40%, var(--neon) 0%, #35ff8a55 45%, transparent 70%);
  box-shadow:0 0 14px var(--neon), 0 0 28px color-mix(in oklab, var(--neon) 45%, transparent);
  animation:pulse 1.8s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.85}}

/* Overlay shell */
.overlay{position:fixed;inset:0;display:none;z-index:2147483646}
.overlay.show{display:block!important}
.shell{max-width:1200px;margin:24px auto;padding:18px}
.head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.3px;
  text-shadow:0 0 8px color-mix(in oklab, var(--neon) 60%, transparent)}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}

/* Panels & buttons */
.panel{position:relative;border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;
  background:linear-gradient(180deg,color-mix(in oklab, var(--panel1) 70%, #000 30%),
                                    color-mix(in oklab, var(--panel2) 70%, #000 30%));
  box-shadow:0 0 24px #000 inset, 0 0 18px color-mix(in oklab, var(--neon) 12%, transparent)}
.panel::after{content:"";position:absolute;inset:-1px;border-radius:16px;pointer-events:none;
  background:conic-gradient(from 0deg at 50% 50%, transparent, rgba(124,246,255,.07), transparent 30%);
  filter:blur(18px);opacity:.7;mix-blend-mode:screen;animation:ring 8s linear infinite}
@keyframes ring{to{transform:rotate(360deg)}}
.btn{all:unset;cursor:pointer;padding:10px 14px;border-radius:12px;color:var(--text);
  border:1px solid color-mix(in oklab, var(--neon2) 70%, transparent);
  background:linear-gradient(180deg,#0a1b17,#0a131a);
  box-shadow:0 0 16px color-mix(in oklab, var(--neon2) 35%, transparent), inset 0 0 14px #10353f55;
  font-weight:900}
.btn--hot{border-color:color-mix(in oklab, var(--hot) 70%, transparent);
  box-shadow:0 0 18px color-mix(in oklab, var(--hot) 40%, transparent), inset 0 0 12px #3c0f2644}
.badge{padding:6px 10px;border-radius:10px;border:1px solid color-mix(in oklab, var(--neon) 70%, transparent);
  background:linear-gradient(180deg,#0b1c16,#091215);box-shadow:0 0 10px color-mix(in oklab, var(--neon) 20%, transparent) inset;
  font-weight:700;color:var(--muted)}
.label{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
.range{width:190px;height:12px;border-radius:999px;background:linear-gradient(90deg,#072617,#0b3a23);
  outline:1px solid color-mix(in oklab, var(--neon) 45%, transparent);box-shadow:0 0 10px color-mix(in oklab, var(--neon) 25%, transparent) inset}
.hint{font-size:12px;color:var(--muted);margin-top:6px}

/* Canvas area */
.stage{position:relative;border:1px solid var(--line);border-radius:16px;overflow:hidden;height:min(70vh,780px);
  box-shadow:0 0 20px #000 inset, 0 0 22px color-mix(in oklab, var(--gold) 12%, transparent)}
#kale{width:100%;height:100%;display:block;background:#050a0d}

/* Controls hide */
.controls{transition:opacity .25s ease, transform .25s ease}
.controls.hidden{opacity:.0;transform:translateY(-8px);pointer-events:none}

/* Inserts area (for future add-ons) */
#inserts{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.insertSlot{grid-column:span 12;border:1px dashed #2b4b3f66;border-radius:12px;padding:12px;color:#9fd8bf;
  background:linear-gradient(180deg,#0a1412,#0a1015)}
@media (min-width:900px){ .insertSlot{grid-column:span 6} }
</style>
</head>
<body>
<div class="bg" aria-hidden="true"></div>

<!-- Launch -->
<button id="btn-t2" onclick="(function(){var o=document.getElementById('overlay');if(o){o.classList.add('show');}})();">
  ‚ú®üåÄ <span style="margin-left:6px">Kaleidoscope</span> <span class="glow">Open</span>
</button>

<!-- Overlay -->
<div id="overlay" class="overlay">
  <div class="shell">
    <div class="head">
      <div class="brand">üåà Kaleidoscope ‚Ä¢ Psychedelic Pro</div>
      <div class="row">
        <span id="status" class="badge">Running</span>
        <button class="btn" onclick="document.getElementById('overlay').classList.remove('show')">‚úñ Close</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="panel controls" id="controls">
      <div class="row">
        <button class="btn btn--hot" id="toggleRun">‚è∏ Pause</button>
        <button class="btn" id="randomize">üé≤ Randomize</button>
        <button class="btn" id="screenshot">üì∏ Snapshot</button>
        <button class="btn" id="hideControls">ü´• Hide Controls</button>
      </div>
      <div class="row" style="margin-top:6px">
        <label class="label">üßø Segments <input id="segments" class="range" type="range" min="4" max="64" step="1" value="16"></label>
        <label class="label">‚ö° Speed <input id="speed" class="range" type="range" min="0" max="2" step="0.01" value="1.0"></label>
        <label class="label">üåà Hue Shift <input id="hue" class="range" type="range" min="0" max="360" step="1" value="0"></label>
        <label class="label"><input type="checkbox" id="glow" checked> ‚ú® Glow</label>
        <label class="label"><input type="checkbox" id="mirror" checked> ü™û Mirror</label>
      </div>
      <div class="hint">Tip: Higher segments look smoother on desktop; reduce on phones for FPS.</div>
    </div>

    <!-- Stage -->
    <div class="panel stage">
      <canvas id="kale"></canvas>
    </div>

    <!-- Inserts (for later add-ons) -->
    <div class="panel">
      <strong>üîå Inserts</strong>
      <div id="inserts">
        <div class="insertSlot">Drop future widgets here (e.g., audio-reactive, image loader, etc.).</div>
      </div>
    </div>
  </div>
</div>

<script>
(()=> {
  /* ---------- Grabs ---------- */
  const $=s=>document.querySelector(s);
  const canvas=$('#kale'), ctx=canvas.getContext('2d',{alpha:false});
  const segEl=$('#segments'), spdEl=$('#speed'), hueEl=$('#hue');
  const glowEl=$('#glow'), mirrorEl=$('#mirror');
  const toggleRun=$('#toggleRun'), randomize=$('#randomize'), status=$('#status');
  const screenshot=$('#screenshot'), hideCtl=$('#hideControls'), controls=$('#controls');

  /* ---------- Size & DPR ---------- */
  let W=0,H=0, running=true, t=0;
  function fit(){
    const r=canvas.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
    W=Math.max(2, Math.floor(r.width*dpr));
    H=Math.max(2, Math.floor(r.height*dpr));
    canvas.width=W; canvas.height=H;
    ctx.setTransform(1,0,0,1,0,0);
  }
  new ResizeObserver(fit).observe(canvas); fit();

  /* ---------- Palette ---------- */
  function rand(n=1){ return Math.random()*n }
  let palette = makePalette();
  function makePalette(){
    const base = Math.floor(rand(360));
    return [
      `hsl(${base},100%,60%)`,
      `hsl(${(base+60)%360},100%,60%)`,
      `hsl(${(base+180)%360},100%,60%)`,
      `hsl(${(base+300)%360},100%,60%)`
    ];
  }

  /* ---------- Offscreen plasma (source texture) ---------- */
  const tex=document.createElement('canvas'), tctx=tex.getContext('2d');
  function resizeTex(){
    const dpr=window.devicePixelRatio||1;
    tex.width=Math.max(256, Math.min(1024, Math.floor(W/2)));
    tex.height=Math.max(256, Math.min(1024, Math.floor(H/2)));
    tctx.setTransform(1,0,0,1,0,0);
  }
  resizeTex();

  function drawPlasma(time){
    const w=tex.width, h=tex.height, img=tctx.createImageData(w,h), data=img.data;
    const hueShift = (+hueEl.value);
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const nx = x/w - .5, ny = y/h - .5;
        const v = 0.5+0.5*Math.sin(6*nx + time*.002) * Math.cos(6*ny - time*.0017)
                + 0.25*Math.sin((nx*nx+ny*ny)*18 - time*.0013);
        const c = Math.floor(v*3.99);
        const col = palette[c%palette.length];
        // quick HSL parse: hsl(H,S%,L%)
        const m = /hsl\((\d+),(\d+)%\,(\d+)%\)/.exec(col);
        let Hh=(+m[1]+hueShift)%360, S=+m[2], L=+m[3];
        const rgb = hsl2rgb(Hh/360,S/100,L/100);
        const i=(y*w+x)*4;
        data[i]=rgb[0]; data[i+1]=rgb[1]; data[i+2]=rgb[2]; data[i+3]=255;
      }
    }
    tctx.putImageData(img,0,0);
  }

  function hsl2rgb(h,s,l){
    if(s===0){ const g=Math.round(l*255); return [g,g,g]; }
    const q = l<.5 ? l*(1+s) : l + s - l*s;
    const p = 2*l - q;
    const r = hue2rgb(p,q,h+1/3), g=hue2rgb(p,q,h), b=hue2rgb(p,q,h-1/3);
    return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];
  }
  function hue2rgb(p,q,t){ if(t<0)t+=1; if(t>1)t-=1; if(t<1/6)return p+(q-p)*6*t; if(t<1/2)return q; if(t<2/3)return p+(q-p)*(2/3-t)*6; return p }

  /* ---------- Kaleidoscope render ---------- */
  function render(time){
    if(!running){ requestAnimationFrame(render); return; }
    t += (+spdEl.value||0)*16.6667; // speed factor
    if(tex.width !== Math.max(256, Math.min(1024, Math.floor(W/2)))) resizeTex();
    drawPlasma(t);

    // Clear
    ctx.globalCompositeOperation='source-over';
    ctx.fillStyle='#05090c'; ctx.fillRect(0,0,W,H);

    const cx=W/2, cy=H/2;
    const segs = Math.max(2, (+segEl.value|0));
    const angle = (Math.PI*2)/segs;
    const radius = Math.hypot(W,H)*0.6;
    const mirror = mirrorEl.checked;

    // Optional glow
    if(glowEl.checked){
      ctx.shadowColor='rgba(124,246,255,0.35)';
      ctx.shadowBlur=Math.max(10, Math.min(40, Math.floor(Math.min(W,H)/40)));
    }else{
      ctx.shadowBlur=0;
    }

    for(let i=0;i<segs;i++){
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(i*angle);

      // Clip wedge
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,radius, -angle/2, angle/2);
      ctx.closePath();
      ctx.clip();

      // Draw the texture into the wedge with transform
      ctx.rotate(-angle/2);
      const flip = mirror && (i%2===1);
      if(flip){ ctx.scale(1,-1) }
      const scale = 1.2; // slightly zoomed
      ctx.drawImage(tex, -tex.width*scale*0.5, -radius*0.8, tex.width*scale, radius*1.6);
      ctx.restore();
    }

    // Subtle center iris
    ctx.save();
    const grd=ctx.createRadialGradient(cx,cy,0,cx,cy,Math.min(W,H)*0.5);
    grd.addColorStop(0,'rgba(0,0,0,0)');
    grd.addColorStop(1,'rgba(0,0,0,0.25)');
    ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
    ctx.restore();

    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);

  /* ---------- Controls ---------- */
  toggleRun.onclick=()=>{ running=!running; status.textContent=running?'Running':'Paused'; toggleRun.textContent = running?'‚è∏ Pause':'‚ñ∂ Play' };
  randomize.onclick=()=>{ palette=makePalette() };
  hueEl.oninput=()=>{/* handled in plasma step */};
  spdEl.oninput=()=>{/* handled in loop */};
  segEl.oninput=()=>{/* takes effect next frame */};
  glowEl.onchange=()=>{/* handled in loop */};
  mirrorEl.onchange=()=>{/* handled in loop */};

  screenshot.onclick=()=>{
    const a=document.createElement('a');
    a.download='kaleidoscope.png';
    a.href=canvas.toDataURL('image/png');
    a.click();
  };

  // Hide/show control panel (doesn't cover Close)
  let hidden=false;
  hideCtl.onclick=()=>{
    hidden=!hidden;
    controls.classList.toggle('hidden', hidden);
    hideCtl.textContent = hidden ? 'üëÅ Show Controls' : 'ü´• Hide Controls';
  };

  // Resize handler
  window.addEventListener('resize', fit, {passive:true});
})();
</script>
</body>
</html>
